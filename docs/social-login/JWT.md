# JWT?

> JSON Web Tokeㅜ

## 세션 기반 인증 vs 토큰 기반 인증

### 세션 기반 인증

> 서버가 사용자의 로그인 상태를 기억하고 있음

1. 사용자가 로그인을 하면 서버는 세션 저장소에서 사용자의 정보를 조회한다
2. 정보를 조회한 뒤 세션 id를 발급한다
3. 사용자는 발급받은 세션 id를 브라우저의 쿠키에 저장한다
4. 사용자는 다른 요청을 보낼때마다 서버는 세션 저장소에서 세션을 조회한후
5. 로그인 여부를 결정하여 작업을 처리하고 응답한다
6. 세션 저장소는 메모리,디스크,데이터베이스등을 사용한다

### 세션기반인증의 단점

- 서버를 확장하기 번거롭다
- 서버의 인스턴스가 여러개라면, 모든 서버는 같은 세션을 공유해야 하기 때문이다
- 세션전용 데이터베이스를 만들어야 한다

### 토큰 기반 인증

> 토큰은 로그인 이후 서버가 만들어 주는 문자열으로, 문자열 안에는 로그인 정보인 서버에서 발급되었음을 증명하는 서명이 들어있다

- 서명 데이터는 해싱 알고리즘으로 만들어지고, RSA SHA256 또는 HMAC SHA256알고리즘이 사용된다

1. 서버에서 만든 토큰은 서명이 있기 때문에 무결성이 보장된다
   > 정보가 변경되거나 위조되지 않았음을 의미한다
2. 사용자가 로그인하면 서버에서 사용자에게 해당 사용자의 정보를 지니는 토큰을 발급해 주고
3. 사용자가 다른 API를 요청하게 될 때 발급 받은 토큰과 함께 요청하게 한다
4. 서버는 해당 토큰이 유효한지 검사하고 결과에 따라 응답한다

### 토크기반의 장점

- 서버에서 사용자의 로그인 정보를 기억하기 위해 사용하는 리소스가 적다
- 사용자쪽에서 로그인 상태를 지닌 토큰을 가지고 있기 때문에 서버의 확장성이 높다

### jwt

npm i jsonwebtoken

1. 첫번째 파라미터로 토크안에 넣고 싶은 데이터
2. 두번째 파라미터로 JWT 시크릿 키

```js
const token = jwt.sign(
    //첫번째 파라미터로 토크안에 넣고 싶은 데이터 패스워드는 X
    {
      _id: this.id,
      username: this.username,
    },
    //두번째 파리미터로 JWT 시크릿 키를 넣음
    process.env.JWT_SECRET,
    {
      expireIn: '7d',
    },
  );
  return token;
};
```

### 사용자의 토큰 관리

#### 1. localStorage , sessionStorage에 저장

- 누군가가 페이지에 악성 스크립트를 삽입한다면 쉽게 토큰을 탈취 할 수 있습니다(XSS cross site scripting )

#### 2. 브라우저의 쿠키에 담아 사용

- 쿠키는 httpOnly라는 속성을 활성화하여 자바스크립트를 통해 쿠키를 조회할 수 없으므로 악성스크립트로 안전
- 대신 CSRF라는 공격에 취약해질 수 있음
  - 토큰을 쿠키에 담으면 사용자가 서버에 요청을 할 때마다 무조건 토큰이 함께 전달됨
  - 사용자가 모르게 원하지 않는 API요청을 하게 만듬
  - 사용자가 자신도 모르는 상황에서 글을 작성하거나, 삭제, 탈퇴를 하게 만들 수 있음

```js
const token = user.generateToken();
ctx.cookies.set("access_token", token, {
  maxAge: 1000 * 60 * 60 * 24 * 7,
  httpOnly: true,
});
```
